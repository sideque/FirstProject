<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User Profile</title>
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body>
  <!-- Hero Banner Section -->
  <div class="hero-wrap hero-bread">
    <div class="container">
      <div class="row no-gutters slider-text align-items-center justify-content-center">
        <div class="col-md-9 ftco-animate text-center">
          <p class="breadcrumbs"><span class="mr-2"><a href="/">Home</a></span> <span>Profile</span></p>
          <h1 class="mb-0 bread">My Profile</h1>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Profile Section -->
  <section class="ftco-section bg-light">
    <div class="container">
      <div class="profile-container">
        <!-- Profile Sidebar -->
        <div class="profile-sidebar">
          <img src="<%= user.profileImage || '/images/default-avatar.png' %>" alt="Profile Picture" class="profile-pic">
          <h3 class="profile-name"><%= user.name %></h3>
          <ul class="profile-nav">
            <li><a href="#" class="active" onclick="showTab('profile-details')"><i class="fa fa-user"></i> My Details</a></li>
            <li><a href="#" onclick="showTab('profile-addresses')"><i class="fa fa-map-marker"></i> My Addresses</a></li>
            <li><a href="#" onclick="showTab('profile-orders')"><i class="fa fa-shopping-bag"></i> Order History</a></li>
            <li><a href="#" onclick="showTab('profile-edit')"><i class="fa fa-pencil"></i> Edit Profile</a></li>
            <li><a href="#" onclick="showTab('profile-security')"><i class="fa fa-lock"></i> Change Password</a></li>
            <li><a href="/logout"><i class="fa fa-sign-out"></i> Logout</a></li>
          </ul>
        </div>

        <!-- Profile Content Area -->
        <div class="profile-content">
          <!-- Profile Details Tab -->
          <div id="profile-details" class="profile-tab active">
            <div class="content-card">
              <div class="content-header">
                <h3 class="content-title">Personal Information</h3>
              </div>
              <div class="user-details">
                <div class="detail-item">
                  <div class="detail-label">Full Name</div>
                  <div class="detail-value"><%= user.name %></div>
                </div>
                <div class="detail-item">
                  <div class="detail-label">Email Address</div>
                  <div class="detail-value"><%= user.email %></div>
                </div>
                <div class="detail-item">
                  <div class="detail-label">Phone Number</div>
                  <div class="detail-value"><%= user.phone || 'Not added yet' %></div>
                </div>
                <div class="detail-item">
                  <div class="detail-label">Account Created</div>
                  <div class="detail-value"><%= new Date(user.createdAt).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) %></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Addresses Tab -->
          <div id="profile-addresses" class="profile-tab" style="display: none;">
            <div class="content-card">
              <div class="content-header">
                <h3 class="content-title">My Addresses</h3>
                <button class="btn btn-primary" onclick="openAddressModal()">Add New Address</button>
              </div>
              <div class="address-grid">
                <% if (user.addresses && user.addresses.length > 0) { %>
                  <% user.addresses.forEach(function(address, index) { %>
                    <div class="address-card">
                      <% if (address.isDefault) { %>
                        <span class="address-type">Default</span>
                      <% } %>
                      <h4><%= address.name %></h4>
                      <p><%= address.addressLine1 %></p>
                      <p><%= address.addressLine2 %></p>
                      <p><%= address.city %>, <%= address.state %> <%= address.pincode %></p>
                      <p>Phone: <%= address.phone %></p>
                      <div class="address-actions">
                        <button onclick="editAddress('<%= index %>')">Edit</button>
                        <% if (!address.isDefault) { %>
                          <button onclick="setDefaultAddress('<%= index %>')">Set as Default</button>
                        <% } %>
                        <button class="delete" onclick="deleteAddress('<%= index %>')">Delete</button>
                      </div>
                    </div>
                  <% }); %>
                <% } else { %>
                  <div class="add-address" onclick="openAddressModal()">
                    <span><i class="fa fa-plus"></i> Add New Address</span>
                  </div>
                <% } %>
              </div>
            </div>
          </div>

          <!-- Orders Tab -->
          <div id="profile-orders" class="profile-tab" style="display: none;">
            <div class="content-card">
              <div class="content-header">
                <h3 class="content-title">Order History</h3>
              </div>
              <div class="order-list">
                <% if (orders && orders.length > 0) { %>
                  <% orders.forEach(function(order) { %>
                    <div class="order-card">
                      <div class="order-header">
                        <div class="order-id">Order #<%= order._id %></div>
                        <div class="order-date"><%= new Date(order.createdAt).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) %></div>
                        <div class="order-status status-<%= order.status.toLowerCase() %>"><%= order.status %></div>
                      </div>
                      <div class="order-body">
                        <% order.products.slice(0, 2).forEach(function(product) { %>
                          <div class="order-product">
                            <img src="<%= product.image %>" alt="<%= product.name %>" class="product-img">
                            <div class="product-details">
                              <div class="product-name"><%= product.name %></div>
                              <div class="product-meta">Qty: <%= product.quantity %></div>
                              <div class="product-price">₹<%= product.price.toLocaleString() %></div>
                            </div>
                          </div>
                        <% }); %>
                        <% if (order.products.length > 2) { %>
                          <div class="more-products">+ <%= order.products.length - 2 %> more products</div>
                        <% } %>
                      </div>
                      <div class="order-footer">
                        <div class="order-total">Total: ₹<%= order.totalAmount.toLocaleString() %></div>
                        <div class="order-actions">
                          <a href="/order/<%= order._id %>" class="btn-details">View Details</a>
                          <% if (order.status === 'Processing' || order.status === 'Confirmed') { %>
                            <a href="#" onclick="cancelOrder('<%= order._id %>')" class="btn-cancel">Cancel Order</a>
                          <% } %>
                          <% if (order.status === 'Shipped') { %>
                            <a href="/order/track/<%= order._id %>" class="btn-track">Track Order</a>
                          <% } %>
                        </div>
                      </div>
                    </div>
                  <% }); %>
                <% } else { %>
                  <div class="no-orders">
                    <p>You haven't placed any orders yet.</p>
                    <a href="/shop" class="btn btn-primary">Start Shopping</a>
                  </div>
                <% } %>
              </div>
            </div>
          </div>

          <!-- Edit Profile Tab -->
          <div id="profile-edit" class="profile-tab" style="display: none;">
            <div class="content-card">
              <div class="content-header">
                <h3 class="content-title">Edit Profile</h3>
              </div>
              <form id="edit-profile-form" action="/profile/update" method="POST" enctype="multipart/form-data">
                <div class="form-group">
                  <label class="form-label">Profile Picture</label>
                  <div class="profile-pic-upload">
                    <img src="<%= user.profileImage || '/images/default-avatar.png' %>" alt="Profile Picture" id="profile-preview">
                    <input type="file" id="profile-image" name="profileImage" accept="image/*" style="display: none;">
                    <button type="button" class="btn btn-secondary" onclick="document.getElementById('profile-image').click()">Change Picture</button>
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-group">
                    <label class="form-label" for="name">Full Name</label>
                    <input type="text" class="form-control" id="name" name="name" value="<%= user.name %>" required>
                  </div>
                  <div class="form-group">
                    <label class="form-label" for="phone">Phone Number</label>
                    <input type="tel" class="form-control" id="phone" name="phone" value="<%= user.phone || '' %>">
                  </div>
                </div>
                <div class="form-group">
                  <label class="form-label" for="email">Email Address</label>
                  <input type="email" class="form-control" id="email" name="email" value="<%= user.email %>" required>
                  <small class="form-text text-muted">Changing your email will require verification.</small>
                </div>
                <div class="edit-buttons">
                  <button type="button" class="btn btn-secondary" onclick="showTab('profile-details')">Cancel</button>
                  <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
              </form>
            </div>
          </div>

          <!-- Change Password Tab -->
          <div id="profile-security" class="profile-tab" style="display: none;">
            <div class="content-card">
              <div class="content-header">
                <h3 class="content-title">Change Password</h3>
              </div>
              <form id="change-password-form" action="/profile/change-password" method="POST">
                <div class="form-group">
                  <label class="form-label" for="current-password">Current Password</label>
                  <input type="password" class="form-control" id="current-password" name="currentPassword" required>
                </div>
                <div class="form-group">
                  <label class="form-label" for="new-password">New Password</label>
                  <input type="password" class="form-control" id="new-password" name="newPassword" required>
                </div>
                <div class="form-group">
                  <label class="form-label" for="confirm-password">Confirm New Password</label>
                  <input type="password" class="form-control" id="confirm-password" name="confirmPassword" required>
                </div>
                <div class="edit-buttons">
                  <button type="button" class="btn btn-secondary" onclick="showTab('profile-details')">Cancel</button>
                  <button type="submit" class="btn btn-primary">Update Password</button>
                </div>
              </form>

              <div class="forgot-password">
                <p>Forgot your password?</p>
                <button type="button" class="btn btn-secondary" onclick="openForgotPasswordModal()">Reset Password</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Address Modal -->
  <div id="addressModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="addressModalTitle">Add New Address</h3>
        <span class="modal-close" onclick="closeAddressModal()">&times;</span>
      </div>
      <form id="address-form" action="/profile/address/add" method="POST">
        <input type="hidden" id="address-index" name="addressIndex" value="">
        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="address-name">Full Name</label>
            <input type="text" class="form-control" id="address-name" name="name" required>
          </div>
          <div class="form-group">
            <label class="form-label" for="address-phone">Phone Number</label>
            <input type="tel" class="form-control" id="address-phone" name="phone" required>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label" for="address-line1">Address Line 1</label>
          <input type="text" class="form-control" id="address-line1" name="addressLine1" required>
        </div>
        <div class="form-group">
          <label class="form-label" for="address-line2">Address Line 2 (Optional)</label>
          <input type="text" class="form-control" id="address-line2" name="addressLine2">
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="address-city">City</label>
            <input type="text" class="form-control" id="address-city" name="city" required>
          </div>
          <div class="form-group">
            <label class="form-label" for="address-state">State</label>
            <input type="text" class="form-control" id="address-state" name="state" required>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label" for="address-pincode">Pincode</label>
          <input type="text" class="form-control" id="address-pincode" name="pincode" required>
        </div>
        <div class="form-group">
          <label class="form-checkbox">
            <input type="checkbox" id="address-default" name="isDefault">
            Set as default address
          </label>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeAddressModal()">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Address</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Forgot Password Modal (this would be needed since it's referenced in the code) -->
  <div id="forgotPasswordModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Reset Password</h3>
        <span class="modal-close" onclick="closeForgotPasswordModal()">&times;</span>
      </div>
      <form id="forgot-password-form" action="/profile/forgot-password" method="POST">
        <div class="form-group">
          <label class="form-label" for="reset-email">Email Address</label>
          <input type="email" class="form-control" id="reset-email" name="email" value="<%= user.email %>" required>
          <small class="form-text text-muted">We will send a password reset link to this email address.</small>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeForgotPasswordModal()">Cancel</button>
          <button type="submit" class="btn btn-primary">Send Reset Link</button>
        </div>
      </form>
    </div>
  </div>

  <!-- JavaScript for tab switching and modal functionality -->
  <script>
    // Tab switching functionality
    function showTab(tabId) {
      // Hide all tabs
      const tabs = document.querySelectorAll('.profile-tab');
      tabs.forEach(tab => {
        tab.style.display = 'none';
      });
      
      // Show the selected tab
      document.getElementById(tabId).style.display = 'block';
      
      // Update active class in navigation
      const navLinks = document.querySelectorAll('.profile-nav a');
      navLinks.forEach(link => {
        link.classList.remove('active');
        if (link.getAttribute('onclick').includes(tabId)) {
          link.classList.add('active');
        }
      });
    }
    
    // Address modal functions
    function openAddressModal() {
      document.getElementById('addressModal').style.display = 'block';
      document.getElementById('addressModalTitle').textContent = 'Add New Address';
      document.getElementById('address-form').reset();
      document.getElementById('address-index').value = '';
    }
    
    function closeAddressModal() {
      document.getElementById('addressModal').style.display = 'none';
    }
    
    function editAddress(index) {
      // This function would be implemented to populate the modal with address data
      document.getElementById('addressModal').style.display = 'block';
      document.getElementById('addressModalTitle').textContent = 'Edit Address';
      document.getElementById('address-index').value = index;
      
      // Here you would add code to populate the form fields with the address data
      // This would typically involve fetching the address data via JavaScript
    }
    
    function setDefaultAddress(index) {
      // This would send a request to set the address as default
      if (confirm('Set this address as your default?')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/profile/address/default';
        
        const hiddenField = document.createElement('input');
        hiddenField.type = 'hidden';
        hiddenField.name = 'addressIndex';
        hiddenField.value = index;
        
        form.appendChild(hiddenField);
        document.body.appendChild(form);
        form.submit();
      }
    }
    
    function deleteAddress(index) {
      // This would send a request to delete the address
      if (confirm('Are you sure you want to delete this address?')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/profile/address/delete';
        
        const hiddenField = document.createElement('input');
        hiddenField.type = 'hidden';
        hiddenField.name = 'addressIndex';
        hiddenField.value = index;
        
        form.appendChild(hiddenField);
        document.body.appendChild(form);
        form.submit();
      }
    }
    
    function cancelOrder(orderId) {
      // This would send a request to cancel the order
      if (confirm('Are you sure you want to cancel this order?')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/order/cancel';
        
        const hiddenField = document.createElement('input');
        hiddenField.type = 'hidden';
        hiddenField.name = 'orderId';
        hiddenField.value = orderId;
        
        form.appendChild(hiddenField);
        document.body.appendChild(form);
        form.submit();
      }
    }
    
    function openForgotPasswordModal() {
      document.getElementById('forgotPasswordModal').style.display = 'block';
    }
    
    function closeForgotPasswordModal() {
      document.getElementById('forgotPasswordModal').style.display = 'none';
    }
    
    // Profile image preview
    document.getElementById('profile-image').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          document.getElementById('profile-preview').src = e.target.result;
        }
        reader.readAsDataURL(file);
      }
    });
    
    // Close modals when clicking outside
    window.onclick = function(event) {
      if (event.target.className === 'modal') {
        event.target.style.display = 'none';
      }
    }
  </script>
</body>
</html>